<div class="products-container">
  <!-- Header with Navigation -->
  <header class="dashboard-header">
    <div class="header-content">
      <div class="logo-section">
        <h1 class="logo">FeDoan</h1>
        <button class="mobile-menu-toggle" (click)="toggleMobileMenu()">
          <i class="fas fa-bars"></i>
        </button>
        <nav class="main-nav" [class.mobile-open]="isMobileMenuOpen">
          <a href="#" class="nav-link" (click)="navigateToDashboard(); $event.preventDefault()">Trang ch·ªß</a>

          <!-- H√†ng h√≥a with submenu -->
          <div class="nav-item dropdown"
               (mouseenter)="openProductsSubmenu()"
               (mouseleave)="closeProductsSubmenu()">
            <button class="nav-link dropdown-toggle active" type="button"
                    (click)="toggleProductsSubmenu(); $event.stopPropagation()">
              H√†ng h√≥a <i class="fas fa-caret-down"></i>
            </button>

            <div class="submenu" [class.open]="productsSubmenuOpen" role="menu" [attr.aria-hidden]="!productsSubmenuOpen">
              <a href="#" class="nav-link active" (click)="navigateToProducts(); $event.preventDefault()">Danh s√°ch H√†ng h√≥a</a>
              <a href="#" class="nav-link" (click)="navigateToStockIn(); $event.preventDefault()">Nh·∫≠p kho</a>
              <a href="#" class="nav-link" (click)="navigateToInvoices(); $event.preventDefault()">H√≥a ƒë∆°n</a>
              <a href="#" class="nav-link" (click)="navigateToStockOut(); $event.preventDefault()">Xu·∫•t kho</a>
            </div>
          </div>

          <a class="nav-link" routerLink="/pos">B√°n h√†ng</a>
          <a href="#" class="nav-link" (click)="navigateToCustomers(); $event.preventDefault()">Kh√°ch h√†ng</a>
          <a href="#" class="nav-link" (click)="navigateToEmployees(); $event.preventDefault()">Nh√¢n vi√™n</a>
          <a href="#" class="nav-link" (click)="navigateToReports(); $event.preventDefault()">B√°o c√°o</a>
          <a href="#" class="nav-link" (click)="navigateToManufacturers(); $event.preventDefault()">Nh√† s·∫£n xu·∫•t</a>
          <a href="#" class="nav-link" (click)="navigateToInvoices(); $event.preventDefault()">H√≥a ƒë∆°n</a>
          <li>
            <a (click)="navigateToPromotions()" class="nav-link">
              <span class="icon">üéÅ</span>
              <span>Khuy·∫øn m√£i</span>
            </a>
          </li>
        </nav>
      </div>
      
      <div class="user-section">
        <button class="theme-toggle" (click)="changeTheme()" title="ƒê·ªïi theme">
          <i class="fas fa-palette"></i>
          <span>{{ getCurrentThemeLabel() }}</span>
        </button>
        
        <app-notification-bell></app-notification-bell>
        
        <div class="user-profile">
          <img [src]="currentUser.avatar" [alt]="currentUser.name" class="user-avatar">
          <div class="user-info">
            <span class="user-name">{{ currentUser.name }}</span>
            <button class="logout-btn" (click)="logout()" title="ƒêƒÉng xu·∫•t">
              <i class="fas fa-sign-out-alt"></i>
              <span>ƒêƒÉng xu·∫•t</span>
            </button>
          </div>
        </div>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="page-content">
    <div class="content-layout">
      <!-- Mobile Filter Toggle Button -->
      <button class="mobile-filter-toggle" (click)="toggleFilters()" *ngIf="!showFilters">
        <i class="fas fa-filter"></i>
        <span>B·ªô l·ªçc</span>
        <span class="filter-count" *ngIf="hasActiveFilters()">{{ getActiveFilterCount() }}</span>
      </button>

      <!-- Left Sidebar - Filters -->
      <aside class="filters-sidebar" [class.mobile-show]="showFilters">
        <div class="filters-header">
          <h3><i class="fas fa-filter"></i> B·ªô l·ªçc</h3>
          <div class="filters-header-actions">
            <button class="btn-reset-filter" (click)="resetFilters()" title="X√≥a b·ªô l·ªçc">
              <i class="fas fa-redo"></i>
            </button>
            <button class="btn-close-filter" (click)="toggleFilters()" title="ƒê√≥ng">
              <i class="fas fa-times"></i>
            </button>
          </div>
        </div>

        <div class="filters-content">
          <!-- T√¨m ki·∫øm -->
          <div class="filter-group">
            <label><i class="fas fa-search"></i> T√¨m ki·∫øm</label>
            <input type="text" 
                   class="filter-input" 
                   [(ngModel)]="filters.searchText"
                   (input)="applyFilters()"
                   placeholder="T√™n, m√£, danh m·ª•c...">
          </div>

          <!-- Danh m·ª•c -->
          <div class="filter-group">
            <label><i class="fas fa-tags"></i> Danh m·ª•c</label>
            <select class="filter-select" 
                    [(ngModel)]="filters.category"
                    (change)="applyFilters()">
              <option value="">T·∫•t c·∫£</option>
              <option *ngFor="let cat of categories" [value]="cat">{{ cat }}</option>
            </select>
          </div>

          <!-- Tr·∫°ng th√°i -->
          <div class="filter-group">
            <label><i class="fas fa-toggle-on"></i> Tr·∫°ng th√°i</label>
            <select class="filter-select" 
                    [(ngModel)]="filters.status"
                    (change)="applyFilters()">
              <option value="">T·∫•t c·∫£</option>
              <option value="active">Ho·∫°t ƒë·ªông</option>
              <option value="inactive">Ng·ª´ng kinh doanh</option>
            </select>
          </div>

          <!-- M·ª©c t·ªìn kho -->
          <div class="filter-group">
            <label><i class="fas fa-boxes"></i> T·ªìn kho</label>
            <select class="filter-select" 
                    [(ngModel)]="filters.stockLevel"
                    (change)="applyFilters()">
              <option value="">T·∫•t c·∫£</option>
              <option value="low">Th·∫•p (< Min)</option>
              <option value="normal">B√¨nh th∆∞·ªùng</option>
              <option value="high">Cao (> Max)</option>
            </select>
          </div>

          <!-- S·∫Øp x·∫øp -->
          <div class="filter-group">
            <label><i class="fas fa-sort"></i> S·∫Øp x·∫øp theo</label>
            <select class="filter-select" 
                    [(ngModel)]="filters.sortBy"
                    (change)="applyFilters()">
              <option value="name-asc">T√™n A-Z</option>
              <option value="name-desc">T√™n Z-A</option>
              <option value="price-asc">Gi√° th·∫•p ‚Üí cao</option>
              <option value="price-desc">Gi√° cao ‚Üí th·∫•p</option>
            </select>
          </div>
        </div>

        <!-- Filter Summary -->
        <div class="filter-summary">
          <p><strong>{{ filteredProducts.length }}</strong> / {{ products.length }} s·∫£n ph·∫©m</p>
        </div>
      </aside>

      <!-- Overlay for mobile filters -->
      <div class="filters-overlay" 
           [class.active]="showFilters" 
           (click)="toggleFilters()"></div>

      <!-- Right Content Area -->
      <div class="content-area">
        <div class="content-header">
          <h2>Qu·∫£n l√Ω H√†ng h√≥a</h2>
          <button class="btn-add-new" (click)="openAddDialog()" [disabled]="isLoading">
            <i class="fas fa-plus"></i>
            <span>Th√™m s·∫£n ph·∫©m</span>
          </button>
        </div>

        <!-- Loading Spinner -->
        <div class="loading-container" *ngIf="isLoading">
          <i class="fas fa-spinner fa-spin"></i>
          <p>ƒêang t·∫£i d·ªØ li·ªáu...</p>
        </div>

        <!-- Error Message -->
        <div class="error-message" *ngIf="errorMessage && !isLoading">
          <i class="fas fa-exclamation-circle"></i>
          <span>{{ errorMessage }}</span>
        </div>

        <!-- Products Table -->
        <div class="table-container" *ngIf="!isLoading">
          <table class="data-table">
            <thead>
              <tr>
                <th>H√¨nh ·∫£nh</th>
                <th>T√™n s·∫£n ph·∫©m</th>
                <th>Danh m·ª•c</th>
                <th>ƒê∆°n v·ªã</th>
                <th>Gi√°</th>
                <th>S·ªë l∆∞·ª£ng</th>
                <th>T·ªìn kho</th>
                <th>Tr·∫°ng th√°i</th>
                <th>Thao t√°c</th>
              </tr>
            </thead>
            <tbody>
              <ng-container *ngIf="filteredProducts && filteredProducts.length > 0; else noData">
                <tr *ngFor="let product of filteredProducts; trackBy: trackByProductCode">
                  <td>
                    <img *ngIf="product.imageUrl"
                         [src]="getImageUrl(product.imageUrl)"
                         alt="·∫¢nh s·∫£n ph·∫©m"
                         style="width:56px;height:56px;object-fit:cover;border-radius:8px;">
                  </td>
                  <td><strong>{{ product.productName }}</strong></td>
                  <td>{{ getCategoryName(product.categoryId) }}</td>
                  <td>{{ product.unit }}</td>
                  <td class="price-cell">{{ product.price.toLocaleString('vi-VN') }} ‚Ç´</td>
                  <td class="quantity-cell">{{ product.stock }}</td>
                  <td>
                    <span class="stock-badge" [ngClass]="getStockStatus(product)">
                      <i class="fas" [ngClass]="{
                        'fa-arrow-down': getStockStatus(product) === 'low',
                        'fa-check': getStockStatus(product) === 'normal',
                        'fa-arrow-up': getStockStatus(product) === 'high'
                      }"></i>
                      {{ getStockStatus(product) === 'low' ? 'Th·∫•p' : 
                         getStockStatus(product) === 'high' ? 'Cao' : 'B√¨nh th∆∞·ªùng' }}
                    </span>
                  </td>
                  <td>
                    <span class="status-badge" [ngClass]="product.status">
                      {{ product.status === 'active' ? 'Ho·∫°t ƒë·ªông' : 'Ng·ª´ng KD' }}
                    </span>
                  </td>
                  <td>
                    <div class="action-buttons">
                      <button class="btn-action btn-view" (click)="viewProduct(product)" title="Xem chi ti·∫øt" [disabled]="isLoading">
                        <i class="fas fa-eye"></i>
                      </button>
                      <button class="btn-action btn-edit" (click)="editProduct(product)" title="Ch·ªânh s·ª≠a" [disabled]="isLoading">
                        <i class="fas fa-edit"></i>
                      </button>
                      <button class="btn-action btn-delete" (click)="deleteProduct(product)" title="X√≥a" [disabled]="isLoading">
                        <i class="fas fa-trash"></i>
                      </button>
                    </div>
                  </td>
                </tr>
              </ng-container>
              <ng-template #noData>
                <tr>
                  <td colspan="9" class="no-data">
                    <i class="fas fa-inbox"></i>
                    <p>{{ filters.searchText ? 'Kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£ ph√π h·ª£p' : 'Ch∆∞a c√≥ d·ªØ li·ªáu s·∫£n ph·∫©m' }}</p>
                  </td>
                </tr>
              </ng-template>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </main>

  <!-- Add/Edit Product Dialog -->
  <div class="dialog-overlay" [class.active]="showDialog" (click)="closeDialog()">
    <div class="dialog-container" (click)="$event.stopPropagation()">
      <div class="dialog-header">
        <h3>{{ isEditMode ? 'Ch·ªânh s·ª≠a s·∫£n ph·∫©m' : 'Th√™m s·∫£n ph·∫©m m·ªõi' }}</h3>
        <button class="btn-close" (click)="closeDialog()">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <!-- Error Message in Dialog -->
      <div class="dialog-error" *ngIf="errorMessage">
        <i class="fas fa-exclamation-triangle"></i>
        <span>{{ errorMessage }}</span>
      </div>

      <form class="dialog-form" (ngSubmit)="saveProduct()">
        <div class="form-grid">
          <!-- M√£ SP -->
          <div class="form-group">
            <label for="productCode">M√£ s·∫£n ph·∫©m <span class="required">*</span></label>
            <input type="text" id="productCode" [(ngModel)]="currentProduct.productCode" 
                   name="productCode" placeholder="VD: a1b2c3d4" required readonly maxlength="8">
            <small class="form-hint">M√£ s·∫Ω ƒë∆∞·ª£c t·∫°o t·ª± ƒë·ªông (8 k√Ω t·ª±)</small>
          </div>

          <!-- SKU -->
          <div class="form-group">
            <label for="sku">SKU <span class="required">*</span></label>
            <input type="text" id="sku" [(ngModel)]="currentProduct.sku" 
                   name="sku" placeholder="VD: IP15PM-256-BLACK" required>
          </div>

          <!-- T√™n SP -->
          <div class="form-group full-width">
            <label for="productName">T√™n s·∫£n ph·∫©m <span class="required">*</span></label>
            <input type="text" id="productName" [(ngModel)]="currentProduct.productName" 
                   name="productName" placeholder="VD: ƒêi·ªán tho·∫°i iPhone 15 Pro Max 256GB" required>
          </div>

          <!-- Danh m·ª•c -->
          <div class="form-group">
            <label for="categoryId">Danh m·ª•c <span class="required">*</span></label>
            <div class="input-with-button">
              <select id="categoryId" [(ngModel)]="currentProduct.categoryId" name="categoryId" required>
                <option value="0">-- Ch·ªçn danh m·ª•c --</option>
                <option *ngFor="let cat of categories" [value]="cat.categoryId">{{ cat.categoryName }}</option>
              </select>
              <button type="button" class="btn-add-category" (click)="openCategoryDialog()" title="Th√™m danh m·ª•c m·ªõi">
                <i class="fas fa-plus"></i>
              </button>
            </div>
          </div>

          <!-- Th∆∞∆°ng hi·ªáu -->
          <div class="form-group">
            <label for="brand">Th∆∞∆°ng hi·ªáu</label>
            <input type="text" id="brand" [(ngModel)]="currentProduct.brand" 
                   name="brand" placeholder="VD: Apple, Samsung...">
          </div>

          <!-- Nh√† cung c·∫•p -->
          <div class="form-group full-width">
            <label for="supplierId">Nh√† cung c·∫•p <span class="required">*</span></label>
            <div class="input-with-button">
              <select id="supplierId" [(ngModel)]="currentProduct.supplierId" name="supplierId" required>
                <option value="0">-- Ch·ªçn nh√† cung c·∫•p --</option>
                <option *ngFor="let sup of suppliers" [value]="sup.supplierId">
                  {{ sup.supplierName }} ({{ sup.supplierCode }})
                </option>
              </select>
              <button type="button" 
                      class="btn-add-supplier" 
                      (click)="navigateToManufacturers()" 
                      title="Qu·∫£n l√Ω nh√† cung c·∫•p">
                <i class="fas fa-external-link-alt"></i>
              </button>
            </div>
            <small class="form-hint" *ngIf="suppliers.length === 0">
              ƒêang t·∫£i danh s√°ch nh√† cung c·∫•p...
            </small>
            <small class="form-hint" *ngIf="suppliers.length > 0">
              {{ suppliers.length }} nh√† cung c·∫•p c√≥ s·∫µn
            </small>
          </div>

          <!-- Gi√° v·ªën -->
          <div class="form-group">
            <label for="costPrice">Gi√° v·ªën <span class="required">*</span></label>
            <input type="number" id="costPrice" [(ngModel)]="currentProduct.costPrice" 
                   name="costPrice" placeholder="VD: 31000000" required min="0">
          </div>

          <!-- Gi√° b√°n -->
          <div class="form-group">
            <label for="price">Gi√° b√°n <span class="required">*</span></label>
            <input type="number" id="price" [(ngModel)]="currentProduct.price" 
                   name="price" placeholder="VD: 34990000" required min="0">
          </div>

          <!-- S·ªë l∆∞·ª£ng t·ªìn -->
          <div class="form-group">
            <label for="stock">S·ªë l∆∞·ª£ng t·ªìn kho <span class="required">*</span></label>
            <input type="number" id="stock" [(ngModel)]="currentProduct.stock" 
                   name="stock" placeholder="VD: 120" required min="0">
          </div>

          <!-- T·ªìn kho t·ªëi thi·ªÉu -->
          <div class="form-group">
            <label for="minStock">T·ªìn kho t·ªëi thi·ªÉu <span class="required">*</span></label>
            <input type="number" id="minStock" [(ngModel)]="currentProduct.minStock" 
                   name="minStock" placeholder="VD: 10" required min="0">
          </div>

          <!-- ƒê∆°n v·ªã -->
          <div class="form-group">
            <label for="unit">ƒê∆°n v·ªã t√≠nh <span class="required">*</span></label>
            <select id="unit" [(ngModel)]="currentProduct.unit" name="unit" required>
              <option *ngFor="let u of units" [value]="u">{{ u }}</option>
            </select>
          </div>

          <!-- Barcode -->
          <div class="form-group">
            <label for="barcode">M√£ v·∫°ch (Barcode)</label>
            <input type="text" id="barcode" [(ngModel)]="currentProduct.barcode" 
                   name="barcode" placeholder="VD: 8934567890123">
          </div>

          <!-- Kh·ªëi l∆∞·ª£ng -->
          <div class="form-group">
            <label for="weight">Kh·ªëi l∆∞·ª£ng (kg)</label>
            <input type="number" id="weight" [(ngModel)]="currentProduct.weight" 
                   name="weight" placeholder="VD: 0.24" min="0" step="0.01">
          </div>

          <!-- K√≠ch th∆∞·ªõc -->
          <div class="form-group">
            <label for="dimension">K√≠ch th∆∞·ªõc</label>
            <input type="text" id="dimension" [(ngModel)]="currentProduct.dimension" 
                   name="dimension" placeholder="VD: 160.7 x 77.6 x 7.8 mm">
          </div>

          <!-- URL h√¨nh ·∫£nh -->
          <div class="form-group full-width">
            <label for="imageUrl">H√¨nh ·∫£nh s·∫£n ph·∫©m</label>
            <input type="file" id="imageUrl" accept="image/*"
                   (change)="onImageFileChange($event)" name="imageUrl">
            <div *ngIf="currentProduct.imageUrl" class="image-preview">
              <img [src]="currentProduct.imageUrl" alt="Preview" style="max-width:120px;max-height:120px;border-radius:8px;margin-top:8px;">
            </div>
          </div>

          <!-- M√¥ t·∫£ -->
          <div class="form-group full-width">
            <label for="description">M√¥ t·∫£ s·∫£n ph·∫©m</label>
            <textarea id="description" [(ngModel)]="currentProduct.description" 
                      name="description" rows="2" placeholder="VD: ƒêi·ªán tho·∫°i cao c·∫•p c·ªßa Apple..."></textarea>
          </div>

          <!-- Ghi ch√∫ -->
          <div class="form-group full-width">
            <label for="notes">Ghi ch√∫</label>
            <textarea id="notes" [(ngModel)]="currentProduct.notes" 
                      name="notes" rows="2" placeholder="VD: H√†ng ch√≠nh h√£ng, b·∫£o h√†nh 12 th√°ng"></textarea>
          </div>

          <!-- Tr·∫°ng th√°i -->
          <div class="form-group">
            <label for="status">Tr·∫°ng th√°i <span class="required">*</span></label>
            <select id="status" [(ngModel)]="currentProduct.status" name="status" required>
              <option value="active">Ho·∫°t ƒë·ªông</option>
              <option value="inactive">Ng·ª´ng kinh doanh</option>
            </select>
          </div>
        </div>

        <div class="dialog-footer">
          <button type="button" class="btn-cancel" (click)="closeDialog()" [disabled]="isLoading">
            <i class="fas fa-times"></i>
            H·ªßy
          </button>
          <button type="submit" class="btn-save" [disabled]="isLoading">
            <i class="fas" [ngClass]="isLoading ? 'fa-spinner fa-spin' : 'fa-save'"></i>
            {{ isLoading ? 'ƒêang l∆∞u...' : (isEditMode ? 'C·∫≠p nh·∫≠t' : 'Th√™m m·ªõi') }}
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Category Dialog -->
  <div class="dialog-overlay" [class.active]="showCategoryDialog" (click)="closeCategoryDialog()">
    <div class="dialog-container small-dialog" (click)="$event.stopPropagation()">
      <div class="dialog-header">
        <h3>Th√™m danh m·ª•c m·ªõi</h3>
        <button class="btn-close" (click)="closeCategoryDialog()">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <form class="dialog-form" (ngSubmit)="saveCategory()">
        <div class="form-group">
          <label for="categoryName">T√™n danh m·ª•c <span class="required">*</span></label>
          <input type="text" 
                 id="categoryName" 
                 [(ngModel)]="newCategoryName" 
                 name="categoryName" 
                 placeholder="VD: Th·ª±c ph·∫©m, ƒê·ªì u·ªëng..." 
                 required
                 autofocus>
        </div>

        <div class="dialog-footer">
          <button type="button" class="btn-cancel" (click)="closeCategoryDialog()">
            <i class="fas fa-times"></i>
            H·ªßy
          </button>
          <button type="submit" class="btn-save" [disabled]="!newCategoryName || newCategoryName.trim() === ''">
            <i class="fas fa-plus"></i>
            Th√™m danh m·ª•c
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<div class="invoice-container">
  <!-- Header with Navigation -->
  <header class="dashboard-header">
    <div class="header-content">
      <div class="logo-section">
        <h1 class="logo">FeDoan</h1>
        <button class="mobile-menu-toggle" (click)="toggleMobileMenu()">
          <i class="fas fa-bars"></i>
        </button>
        <nav class="main-nav" [class.mobile-open]="isMobileMenuOpen">
          <a href="#" class="nav-link" (click)="navigateToDashboard(); $event.preventDefault()">Trang ch·ªß</a>

          <!-- H√†ng h√≥a with submenu -->
          <div class="nav-item dropdown"
               (mouseenter)="openProductsSubmenu()"
               (mouseleave)="closeProductsSubmenu()">
            <button class="nav-link dropdown-toggle" type="button"
                    (click)="toggleProductsSubmenu(); $event.stopPropagation()">
              H√†ng h√≥a <i class="fas fa-caret-down"></i>
            </button>

            <div class="submenu" [class.open]="productsSubmenuOpen" role="menu" [attr.aria-hidden]="!productsSubmenuOpen">
              <a href="#" class="nav-link" (click)="navigateToProducts(); $event.preventDefault()">Danh s√°ch H√†ng h√≥a</a>
              <a href="#" class="nav-link" (click)="navigateToStockIn(); $event.preventDefault()">Nh·∫≠p kho</a>
              <a href="#" class="nav-link" (click)="navigateToInvoices(); $event.preventDefault()">H√≥a ƒë∆°n</a>
              <a href="#" class="nav-link" (click)="navigateToStockOut(); $event.preventDefault()">Xu·∫•t kho</a>
            </div>
          </div>
          <a class="nav-link" routerLink="/pos">B√°n h√†ng</a>
          <a href="#" class="nav-link" (click)="navigateToCustomers(); $event.preventDefault()">Kh√°ch h√†ng</a>
          <a href="#" class="nav-link" (click)="navigateToEmployees(); $event.preventDefault()">Nh√¢n vi√™n</a>
          <a href="#" class="nav-link" (click)="navigateToReports(); $event.preventDefault()">B√°o c√°o</a>
          <a href="#" class="nav-link" (click)="navigateToManufacturer(); $event.preventDefault()">Nh√† s·∫£n xu·∫•t</a>
          <a href="#" class="nav-link" (click)="navigateToInvoices(); $event.preventDefault()">H√≥a ƒë∆°n</a>
        </nav>
      </div>
      
      <div class="user-section">
        <button class="theme-toggle" (click)="changeTheme()" title="ƒê·ªïi theme">
          <i class="fas fa-palette"></i>
          <span>{{ getCurrentThemeLabel() }}</span>
        </button>
        
        <app-notification-bell></app-notification-bell>
        
        <div class="user-profile">
          <img [src]="currentUser.avatar" [alt]="currentUser.name" class="user-avatar">
          <div class="user-info">
            <span class="user-name">{{ currentUser.name }}</span>
            <button class="logout-btn" (click)="logout()" title="ƒêƒÉng xu·∫•t">
              <i class="fas fa-sign-out-alt"></i>
              <span>ƒêƒÉng xu·∫•t</span>
            </button>
          </div>
        </div>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="page-content">
    <div class="content-layout">
      <!-- Mobile Filter Toggle Button -->
      <button class="mobile-filter-toggle" (click)="toggleFilters()" *ngIf="!showFilters">
        <i class="fas fa-filter"></i>
        <span>B·ªô l·ªçc</span>
        <span class="filter-count" *ngIf="hasActiveFilters()">{{ getActiveFilterCount() }}</span>
      </button>

      <!-- Left Sidebar - Filters -->
      <aside class="filters-sidebar" [class.mobile-show]="showFilters" style="margin-left: -10px;">
        <div class="filters-header">
          <h3><i class="fas fa-filter"></i> B·ªô l·ªçc</h3>
          <div class="filters-header-actions">
            <button class="btn-reset-filter" (click)="resetFilters()" title="X√≥a b·ªô l·ªçc">
              <i class="fas fa-redo"></i>
            </button>
            <button class="btn-close-filter" (click)="toggleFilters()" title="ƒê√≥ng">
              <i class="fas fa-times"></i>
            </button>
          </div>
        </div>

        <div class="filters-content">
          <!-- T√¨m ki·∫øm -->
          <div class="filter-group">
            <label><i class="fas fa-search"></i> T√¨m ki·∫øm</label>
            <input type="text" 
                   class="filter-input" 
                   [(ngModel)]="filters.searchText"
                   (ngModelChange)="applyFilters()"
                   name="searchText"
                   placeholder="M√£ Hƒê, kh√°ch h√†ng...">
          </div>

          <!-- Tr·∫°ng th√°i thanh to√°n -->
          <div class="filter-group">
            <label><i class="fas fa-money-bill-wave"></i> Tr·∫°ng th√°i TT</label>
            <select class="filter-select" 
                    [(ngModel)]="filters.paymentStatus"
                    (ngModelChange)="applyFilters()"
                    name="paymentStatus">
              <option value="">T·∫•t c·∫£</option>
              <option value="paid">ƒê√£ thanh to√°n</option>
              <option value="unpaid">Ch∆∞a thanh to√°n</option>
              <option value="partial">Thanh to√°n 1 ph·∫ßn</option>
              <option value="refunded">ƒê√£ ho√†n ti·ªÅn</option>
            </select>
          </div>

          <!-- T·ª´ ng√†y -->
          <div class="filter-group">
            <label><i class="fas fa-calendar-alt"></i> T·ª´ ng√†y</label>
            <input type="date" 
                   class="filter-input" 
                   [(ngModel)]="filters.dateFrom"
                   (ngModelChange)="applyFilters()"
                   name="dateFrom">
          </div>

          <!-- ƒê·∫øn ng√†y -->
          <div class="filter-group">
            <label><i class="fas fa-calendar-alt"></i> ƒê·∫øn ng√†y</label>
            <input type="date" 
                   class="filter-input" 
                   [(ngModel)]="filters.dateTo"
                   (ngModelChange)="applyFilters()"
                   name="dateTo">
          </div>

          <!-- S·ªë ti·ªÅn t·ªëi thi·ªÉu -->
          <div class="filter-group">
            <label><i class="fas fa-coins"></i> S·ªë ti·ªÅn t·ª´</label>
            <input type="number" 
                   class="filter-input" 
                   [(ngModel)]="filters.minAmount"
                   (ngModelChange)="applyFilters()"
                   name="minAmount"
                   placeholder="0">
          </div>

          <!-- S·ªë ti·ªÅn t·ªëi ƒëa -->
          <div class="filter-group">
            <label><i class="fas fa-coins"></i> S·ªë ti·ªÅn ƒë·∫øn</label>
            <input type="number" 
                   class="filter-input" 
                   [(ngModel)]="filters.maxAmount"
                   (ngModelChange)="applyFilters()"
                   name="maxAmount"
                   placeholder="999,999,999">
          </div>

          <!-- S·∫Øp x·∫øp -->
          <div class="filter-group">
            <label><i class="fas fa-sort"></i> S·∫Øp x·∫øp theo</label>
            <select class="filter-select" 
                    [(ngModel)]="filters.sortBy"
                    (ngModelChange)="applyFilters()"
                    name="sortBy">
              <option value="date-desc">Ng√†y m·ªõi nh·∫•t</option>
              <option value="date-asc">Ng√†y c≈© nh·∫•t</option>
              <option value="amount-desc">S·ªë ti·ªÅn cao nh·∫•t</option>
              <option value="amount-asc">S·ªë ti·ªÅn th·∫•p nh·∫•t</option>
              <option value="code-asc">M√£ A-Z</option>
              <option value="code-desc">M√£ Z-A</option>
            </select>
          </div>
        </div>

        <!-- Filter Summary -->
        <div class="filter-summary">
          <p><strong>{{ filteredInvoices.length }}</strong> / {{ invoices.length }} h√≥a ƒë∆°n</p>
        </div>
      </aside>

      <!-- Overlay for mobile filters -->
      <div class="filters-overlay" 
           [class.active]="showFilters" 
           (click)="toggleFilters()"></div>

      <!-- Right Content Area -->
      <div class="content-area">
        <div class="content-header">
          <h2>Qu·∫£n l√Ω H√≥a ƒë∆°n</h2>
          <button class="btn-add-new" (click)="openAddDialog()" [disabled]="isLoading">
            <i class="fas fa-plus"></i>
            <span>Th√™m m·ªõi</span>
          </button>
        </div>

        <!-- Loading Spinner -->
        <div class="loading-container" *ngIf="isLoading">
          <i class="fas fa-spinner fa-spin"></i>
          <p>ƒêang t·∫£i d·ªØ li·ªáu...</p>
        </div>

        <!-- Error Message -->
        <div class="error-message" *ngIf="errorMessage && !isLoading">
          <i class="fas fa-exclamation-circle"></i>
          <span>{{ errorMessage }}</span>
        </div>

        <!-- Invoices Table -->
        <div class="table-container" *ngIf="!isLoading">
          <table class="data-table">
            <thead>
              <tr>
                <th>M√£ Hƒê</th>
                <th>Kh√°ch h√†ng</th>
                <th>Nh√¢n vi√™n</th>
                <th>Ng√†y t·∫°o</th>
                <th>T·ªïng ti·ªÅn</th>
                <th>Gi·∫£m gi√°</th>
                <th>Th√†nh ti·ªÅn</th>
                <th>Tr·∫°ng th√°i</th>
                <th>Thao t√°c</th>
              </tr>
            </thead>
            <tbody>
              <ng-container *ngIf="filteredInvoices && filteredInvoices.length > 0; else noData">
                <tr *ngFor="let invoice of filteredInvoices; trackBy: trackByInvoiceId">
                  <td><strong>{{ invoice.invoiceCode }}</strong></td>
                  <td>{{ invoice.customerName || 'N/A' }}</td>
                  <td>{{ invoice.employeeName || 'N/A' }}</td>
                  <td>{{ formatDate(invoice.invoiceDate) }}</td>
                  <td class="text-right">{{ formatCurrency(invoice.totalAmount) }}</td>
                  <td class="text-right">{{ formatCurrency(invoice.discountAmount || 0) }}</td>
                  <td class="text-right"><strong>{{ formatCurrency(invoice.finalAmount) }}</strong></td>
                  <td>
                    <span class="status-badge" [ngClass]="getPaymentStatusClass(invoice.paymentStatus)">
                      {{ getPaymentStatusLabel(invoice.paymentStatus) }}
                    </span>
                  </td>
                  <td>
                    <div class="action-buttons">
                      <button class="btn-action btn-view" (click)="viewInvoice(invoice)" title="Xem chi ti·∫øt" [disabled]="isLoading">
                        <i class="fas fa-eye"></i>
                      </button>
                      <button class="btn-action btn-edit" (click)="editInvoice(invoice)" title="Ch·ªânh s·ª≠a" [disabled]="isLoading">
                        <i class="fas fa-edit"></i>
                      </button>
                      <button class="btn-action btn-delete" (click)="deleteInvoice(invoice)" title="X√≥a" [disabled]="isLoading">
                        <i class="fas fa-trash"></i>
                      </button>
                    </div>
                  </td>
                </tr>
              </ng-container>
              <ng-template #noData>
                <tr>
                  <td colspan="9" class="no-data">
                    <i class="fas fa-inbox"></i>
                    <p>{{ filters.searchText ? 'Kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£ ph√π h·ª£p' : 'Ch∆∞a c√≥ d·ªØ li·ªáu h√≥a ƒë∆°n' }}</p>
                  </td>
                </tr>
              </ng-template>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </main>

  <!-- Add/Edit Invoice Dialog -->
  <div class="dialog-overlay" [class.active]="showDialog" (click)="closeDialog()">
    <div class="dialog-container" (click)="$event.stopPropagation()">
      <div class="dialog-header">
        <h3>{{ isEditMode ? 'Ch·ªânh s·ª≠a h√≥a ƒë∆°n' : 'Th√™m h√≥a ƒë∆°n m·ªõi' }}</h3>
        <button class="btn-close" (click)="closeDialog()">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <!-- Error Message in Dialog -->
      <div class="dialog-error" *ngIf="errorMessage">
        <i class="fas fa-exclamation-triangle"></i>
        <span>{{ errorMessage }}</span>
      </div>

      <form class="dialog-form" (ngSubmit)="saveInvoice()">
        <div class="form-grid">
          <!-- M√£ h√≥a ƒë∆°n -->
          <div class="form-group">
            <label for="invoiceCode">M√£ h√≥a ƒë∆°n <span class="required">*</span></label>
            <input type="text" id="invoiceCode" [(ngModel)]="currentInvoice.invoiceCode" 
                   name="invoiceCode" placeholder="VD: INV24110001" required readonly>
            <small class="form-hint">M√£ s·∫Ω ƒë∆∞·ª£c t·∫°o t·ª± ƒë·ªông</small>
          </div>

          <!-- Kh√°ch h√†ng (ch·ªçn t·ª´ danh s√°ch) -->
          <div class="form-group">
            <label for="customerId">Kh√°ch h√†ng <span class="required">*</span></label>
            <div *ngIf="isLoadingCustomers">ƒêang t·∫£i danh s√°ch kh√°ch h√†ng...</div>
            <div *ngIf="!isLoadingCustomers">
              <select id="customerId" [(ngModel)]="currentInvoice.customerId" name="customerId" required>
                <option [ngValue]="0">-- Ch·ªçn kh√°ch h√†ng --</option>
                <option *ngFor="let c of customers" [ngValue]="c.customerId">{{ c.customerName || c.customerCode }} </option>
              </select>
            </div>
            <small class="form-hint" *ngIf="customersError">{{ customersError }}</small>
          </div>

          <!-- Nh√¢n vi√™n (ch·ªçn t·ª´ danh s√°ch) -->
          <div class="form-group">
            <label for="employeeId">Nh√¢n vi√™n</label>
            <div *ngIf="isLoadingEmployees">ƒêang t·∫£i danh s√°ch nh√¢n vi√™n...</div>
            <div *ngIf="!isLoadingEmployees">
              <select id="employeeId" [(ngModel)]="currentInvoice.employeeId" name="employeeId">
                <option [ngValue]="null">-- Kh√¥ng ch·ªçn --</option>
                <option *ngFor="let e of employees" [ngValue]="e.employeeId">{{ e.employeeName }}</option>
              </select>
            </div>
            <small class="form-hint" *ngIf="employeesError">{{ employeesError }}</small>
          </div>

          <!-- Ng√†y t·∫°o -->
          <div class="form-group">
            <label for="invoiceDate">Ng√†y t·∫°o <span class="required">*</span></label>
            <input type="date" id="invoiceDate" [(ngModel)]="currentInvoice.invoiceDate" 
                   name="invoiceDate" required>
          </div>

          <!-- T·ªïng ti·ªÅn -->
          <div class="form-group">
            <label for="totalAmount">T·ªïng ti·ªÅn <span class="required">*</span></label>
            <input type="number" id="totalAmount" [(ngModel)]="currentInvoice.totalAmount" 
                   name="totalAmount" placeholder="0" required min="0" step="1000">
          </div>

          <!-- Gi·∫£m gi√° -->
          <div class="form-group">
            <label for="discountAmount">Gi·∫£m gi√°</label>
            <input type="number" id="discountAmount" [(ngModel)]="currentInvoice.discountAmount" 
                   name="discountAmount" placeholder="0" min="0" step="1000">
          </div>

          <!-- Th√†nh ti·ªÅn -->
          <div class="form-group">
            <label for="finalAmount">Th√†nh ti·ªÅn <span class="required">*</span></label>
            <input type="number" id="finalAmount" [(ngModel)]="currentInvoice.finalAmount" 
                   name="finalAmount" placeholder="0" required min="0" step="1000">
          </div>

          <!-- ƒê√£ thanh to√°n -->
          <div class="form-group">
            <label for="amountPaid">ƒê√£ thanh to√°n</label>
            <input type="number" id="amountPaid" [(ngModel)]="currentInvoice.amountPaid" 
                   name="amountPaid" placeholder="0" min="0" step="1000">
          </div>

          <!-- Ph∆∞∆°ng th·ª©c thanh to√°n -->
          <div class="form-group">
            <label for="paymentMethodId">ID Ph∆∞∆°ng th·ª©c TT</label>
            <input type="number" id="paymentMethodId" [(ngModel)]="currentInvoice.paymentMethodId" 
                   name="paymentMethodId" placeholder="Nh·∫≠p ID ph∆∞∆°ng th·ª©c" min="1">
          </div>

          <!-- Tr·∫°ng th√°i thanh to√°n -->
          <div class="form-group">
            <label for="paymentStatus">Tr·∫°ng th√°i TT <span class="required">*</span></label>
            <select id="paymentStatus" [(ngModel)]="currentInvoice.paymentStatus" name="paymentStatus" required>
              <option value="unpaid">Ch∆∞a thanh to√°n</option>
              <option value="paid">ƒê√£ thanh to√°n</option>
              <option value="partial">Thanh to√°n 1 ph·∫ßn</option>
              <option value="refunded">ƒê√£ ho√†n ti·ªÅn</option>
            </select>
          </div>

          <!-- Ghi ch√∫ -->
          <div class="form-group full-width">
            <label for="notes">Ghi ch√∫</label>
            <textarea id="notes" [(ngModel)]="currentInvoice.notes" 
                      name="notes" rows="3" placeholder="Nh·∫≠p ghi ch√∫ (n·∫øu c√≥)"></textarea>
          </div>
        </div>

        <!-- Th√™m section khuy·∫øn m√£i v√†o form h√≥a ƒë∆°n -->
        <div class="invoice-summary">
          <div class="summary-row">
            <span>T·∫°m t√≠nh:</span>
            <span class="amount">{{ formatCurrency(subtotal) }}</span>
          </div>

          <!-- Promotion Section -->
          <div class="promotion-section">
            <div class="promotion-input-group" *ngIf="!appliedPromotion">
              <input 
                type="text" 
                [(ngModel)]="promotionCode" 
                placeholder="Nh·∫≠p m√£ khuy·∫øn m√£i"
                class="promotion-input"
                [disabled]="isValidatingPromotion">
              <button 
                (click)="applyPromotionCode()" 
                class="btn-apply-promotion"
                [disabled]="isValidatingPromotion || !promotionCode.trim()">
                {{ isValidatingPromotion ? '‚è≥' : '‚úì' }} √Åp d·ª•ng
              </button>
            </div>

            <div class="applied-promotion" *ngIf="appliedPromotion">
              <div class="promotion-info">
                <span class="promotion-icon">üéÅ</span>
                <div class="promotion-details">
                  <strong>{{ appliedPromotion.promotionName }}</strong>
                  <span class="promotion-code">{{ appliedPromotion.promotionCode }}</span>
                </div>
                <button (click)="removePromotion()" class="btn-remove-promotion">‚úï</button>
              </div>
            </div>
          </div>

          <div class="summary-row discount" *ngIf="promotionDiscount > 0">
            <span>üéÅ Khuy·∫øn m√£i:</span>
            <span class="amount discount">-{{ formatCurrency(promotionDiscount) }}</span>
          </div>

          <div class="summary-row total">
            <span>T·ªïng c·ªông:</span>
            <span class="amount">{{ formatCurrency(totalAmount) }}</span>
          </div>
        </div>

        <div class="dialog-footer">
          <button type="button" class="btn-cancel" (click)="closeDialog()" [disabled]="isLoading">
            <i class="fas fa-times"></i>
            H·ªßy
          </button>
          <button type="submit" class="btn-save" [disabled]="isLoading">
            <i class="fas" [ngClass]="isLoading ? 'fa-spinner fa-spin' : 'fa-save'"></i>
            {{ isLoading ? 'ƒêang l∆∞u...' : (isEditMode ? 'C·∫≠p nh·∫≠t' : 'Th√™m m·ªõi') }}
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Trang Bán hàng (POS) -->
<div class="pos-container">
  <!-- Toast Notification -->
  <div class="toast-notification" *ngIf="showToast" [class]="'toast-' + toastType">
    <i class="fas" [class.fa-check-circle]="toastType === 'success'" 
                    [class.fa-exclamation-circle]="toastType === 'error'"
                    [class.fa-exclamation-triangle]="toastType === 'warning'"></i>
    <span>{{ toastMessage }}</span>
  </div>

  <!-- Confirm Dialog -->
  <div class="modal-overlay" *ngIf="showConfirmDialog" (click)="confirmNo()">
    <div class="confirm-dialog" (click)="$event.stopPropagation()">
      <div class="confirm-header">
        <h3>{{ confirmTitle }}</h3>
        <button class="btn-close-modal" (click)="confirmNo()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="confirm-body">
        <i class="fas fa-question-circle"></i>
        <p>{{ confirmMessage }}</p>
      </div>
      <div class="confirm-footer">
        <button class="btn-cancel" (click)="confirmNo()">
          <i class="fas fa-times"></i>
          Hủy
        </button>
        <button class="btn-confirm" (click)="confirmYes()">
          <i class="fas fa-check"></i>
          Xác nhận
        </button>
      </div>
    </div>
  </div>
  <!-- Header with Navigation -->
  <header class="dashboard-header">
    <div class="header-content">
      <div class="logo-section">
        <h1 class="logo">FeDoan</h1>
        <button class="mobile-menu-toggle" (click)="toggleMobileMenu()">
          <i class="fas fa-bars"></i>
        </button>
        <nav class="main-nav" [class.mobile-open]="isMobileMenuOpen">
          <a href="#" class="nav-link" (click)="navigateToDashboard(); $event.preventDefault()">Trang chủ</a>
          <a href="#" class="nav-link" (click)="navigateToProducts(); $event.preventDefault()">Hàng hóa</a>
          <a href="#" class="nav-link active" (click)="navigateToPos(); $event.preventDefault()">Bán hàng</a>
          <a href="#" class="nav-link" (click)="navigateToCustomers(); $event.preventDefault()">Khách hàng</a>
          <a href="#" class="nav-link" (click)="navigateToEmployees(); $event.preventDefault()">Nhân viên</a>
          <a href="#" class="nav-link" (click)="navigateToReports(); $event.preventDefault()">Báo cáo</a>
          <a href="#" class="nav-link" (click)="navigateToManufacturers(); $event.preventDefault()">Nhà sản xuất</a>
          <a href="#" class="nav-link" (click)="navigateToInvoices(); $event.preventDefault()">Hóa đơn</a>
        </nav>
      </div>
      <div class="user-section">
        <button class="theme-toggle" (click)="changeTheme()" title="Đổi theme">
          <i class="fas fa-palette"></i>
          <span>{{ getCurrentThemeLabel() }}</span>
        </button>
        
        <!-- Notification Bell -->
        <div class="notification-wrapper">
          <button class="notification-btn" (click)="toggleNotifications(); $event.stopPropagation()" title="Thông báo">
            <i class="fas fa-bell"></i>
            <span class="notification-badge" *ngIf="unreadNotifications > 0">{{ unreadNotifications }}</span>
          </button>
          
          <!-- Notification Backdrop -->
          <div class="notification-backdrop" *ngIf="showNotifications" (click)="closeNotifications()"></div>
          
          <!-- Notification Dropdown -->
          <div class="notification-dropdown" *ngIf="showNotifications" (click)="$event.stopPropagation()">
            <div class="notification-header">
              <h4>Thông báo</h4>
              <button class="mark-all-read" (click)="markAllAsRead()" *ngIf="unreadNotifications > 0">
                <i class="fas fa-check-double"></i>
                Đánh dấu đã đọc
              </button>
            </div>
            <div class="notification-list">
              <div class="notification-item" 
                   *ngFor="let notification of notifications" 
                   [class.unread]="!notification.isRead"
                   (click)="markAsRead(notification)">
                <div class="notification-icon" [class]="'notification-icon-' + notification.type">
                  <i class="fas" 
                     [class.fa-info-circle]="notification.type === 'info'"
                     [class.fa-exclamation-triangle]="notification.type === 'warning'"
                     [class.fa-check-circle]="notification.type === 'success'"
                     [class.fa-times-circle]="notification.type === 'error'"></i>
                </div>
                <div class="notification-content">
                  <p class="notification-message">{{ notification.message }}</p>
                  <span class="notification-time">{{ notification.time }}</span>
                </div>
              </div>
              <div class="empty-notifications" *ngIf="notifications.length === 0">
                <i class="fas fa-bell-slash"></i>
                <p>Không có thông báo</p>
              </div>
            </div>
          </div>
        </div>
        
        <div class="user-profile">
          <img [src]="currentUser.avatar" [alt]="currentUser.name" class="user-avatar">
          <div class="user-info">
            <span class="user-name">{{ currentUser.name }}</span>
            <button class="logout-btn" (click)="logout()" title="Đăng xuất">
              <i class="fas fa-sign-out-alt"></i>
              <span>Đăng xuất</span>
            </button>
          </div>
        </div>
      </div>
    </div>
  </header>

  <main class="pos-content">
    <div class="pos-layout">
      <!-- Left Side - Products List -->
      <div class="products-section">
        <div class="search-bar">
          <i class="fas fa-search"></i>
          <input type="text" 
                 [(ngModel)]="searchText" 
                 (input)="searchProducts()" 
                 placeholder="Tìm kiếm sản phẩm theo tên, mã hoặc barcode...">
        </div>

        <div class="loading-container" *ngIf="isLoading">
          <i class="fas fa-spinner fa-spin"></i>
          <p>Đang tải sản phẩm...</p>
        </div>

        <div class="error-message" *ngIf="errorMessage && !isLoading">
          <i class="fas fa-exclamation-circle"></i>
          <span>{{ errorMessage }}</span>
        </div>

        <div class="products-grid" *ngIf="!isLoading">
          <div class="product-card" 
               *ngFor="let product of filteredProducts"
               (click)="addToCart(product)"
               [class.out-of-stock]="getAvailableStockForCurrentCart(product.productId) <= 0">
            <div class="product-image">
              <img [src]="getImageUrl(product)" 
                   [alt]="product.productName"
                   (error)="onImageError($event)">
              <span class="stock-badge" 
                    [class.low-stock]="getAvailableStockForCurrentCart(product.productId) < 10"
                    [class.out-of-stock]="getAvailableStockForCurrentCart(product.productId) <= 0">
                {{ getAvailableStockForCurrentCart(product.productId) }} {{ product.unit || 'sp' }}
              </span>
            </div>
            <div class="product-info">
              <h4 class="product-name">{{ product.productName }}</h4>
              <p class="product-code">{{ product.productCode }}</p>
              <p class="product-price">{{ product.price | number:'1.0-0' }} đ</p>
            </div>
            <button class="add-btn" [disabled]="getAvailableStockForCurrentCart(product.productId) <= 0">
              <i class="fas fa-plus"></i>
            </button>
          </div>

          <div class="no-products" *ngIf="filteredProducts.length === 0">
            <i class="fas fa-box-open"></i>
            <p>{{ searchText ? 'Không tìm thấy sản phẩm' : 'Chưa có sản phẩm nào' }}</p>
          </div>
        </div>
      </div>

      <!-- Right Side - Cart -->
      <div class="cart-section">
        <!-- Cart Tabs -->
        <div class="cart-tabs">
          <div class="cart-tab" 
               *ngFor="let cart of carts; let i = index"
               [class.active]="i === activeCartIndex"
               (click)="switchCart(i)">
            <div class="cart-tab-info">
              <span class="cart-tab-name">{{ cart.name }}</span>
              <span class="cart-tab-count" *ngIf="getCartItemCount(i) > 0">
                {{ getCartItemCount(i) }}
              </span>
            </div>
            <button class="btn-close-tab"
                    (click)="deleteCart(i, $event)"
                    *ngIf="carts.length > 1"
                    title="Đóng">
              <i class="fas fa-times"></i>
            </button>
          </div>
          <button class="btn-new-cart" (click)="createNewCart()" title="Tạo đơn mới">
            <i class="fas fa-plus"></i>
          </button>
        </div>

        <div class="cart-header">
          <h3>
            <i class="fas fa-shopping-cart"></i>
            {{ carts[activeCartIndex]?.name || 'Giỏ hàng' }} ({{ getTotalItems() }})
          </h3>
          <button class="btn-clear-cart" (click)="clearCart()" *ngIf="cartItems.length > 0">
            <i class="fas fa-trash"></i>
            Xóa tất cả
          </button>
        </div>

        <div class="cart-items">
          <div class="cart-empty" *ngIf="cartItems.length === 0">
            <i class="fas fa-shopping-cart"></i>
            <p>Giỏ hàng trống</p>
            <small>Chọn sản phẩm để thêm vào giỏ hàng</small>
          </div>

          <div class="cart-item" *ngFor="let item of cartItems" [class.over-stock]="item.quantity > getAvailableStockForCurrentCart(item.product.productId)">
            <div class="item-info">
              <h4>{{ item.product.productName }}</h4>
              <p class="item-code">{{ item.product.productCode }}</p>
              <p class="item-price">{{ item.product.price | number:'1.0-0' }} đ</p>
              <p class="stock-warning" *ngIf="item.quantity > getAvailableStockForCurrentCart(item.product.productId)">
                <i class="fas fa-exclamation-triangle"></i>
                Vượt quá tồn kho! (Còn: {{ getAvailableStockForCurrentCart(item.product.productId) }})
              </p>
            </div>
            <div class="item-controls">
              <div class="quantity-controls">
                <button (click)="updateQuantity(item, item.quantity - 1)">
                  <i class="fas fa-minus"></i>
                </button>
                <input type="number" 
                       [value]="item.quantity" 
                       (keyup)="onQuantityInput(item, $event)"
                       (change)="onQuantityInput(item, $event)"
                       (blur)="validateQuantity(item)"
                       min="1"
                       [max]="getAvailableStockForCurrentCart(item.product.productId)">
                <button (click)="updateQuantity(item, item.quantity + 1)">
                  <i class="fas fa-plus"></i>
                </button>
              </div>
              <p class="item-subtotal">{{ item.subtotal | number:'1.0-0' }} đ</p>
              <button class="btn-remove" (click)="removeFromCart(item)" title="Xóa">
                <i class="fas fa-times"></i>
              </button>
            </div>
          </div>
        </div>

        <div class="cart-footer" *ngIf="cartItems.length > 0">
          <div class="created-invoices" *ngIf="createdInvoices.length > 0">
            <h4>Hóa đơn đã tạo</h4>
            <ul>
              <li *ngFor="let ci of createdInvoices">
                <span class="ci-code">{{ ci.invoiceCode }}</span>
                <span class="ci-amount">{{ ci.finalAmount | number:'1.0-0' }} đ</span>
                <a class="ci-print" [href]="getInvoicePrintUrl(ci.invoiceId)" target="_blank" rel="noopener">In/PDF</a>
              </li>
            </ul>
            <button class="btn-clear-created" (click)="clearCreatedInvoices()">Xóa danh sách</button>
          </div>
          <div class="cart-summary">
            <div class="customer-select">
              <label for="customer">Khách hàng:</label>
              <input id="customer" type="text" placeholder="Gõ tên hoặc số điện thoại (Enter để tạo khách lẻ)" [(ngModel)]="customerSearchText" (input)="onCustomerSearch()" (keydown.enter)="$event.preventDefault(); selectOrCreateCustomer()" />
              <ul class="customer-suggestions" *ngIf="isPhoneQuery() && filteredCustomers.length > 0">
                <li *ngFor="let c of filteredCustomers" (click)="selectCustomer(c)">
                  <strong>{{ c.customerName }}</strong>
                  <small class="muted">{{ c.phone }}</small>
                </li>
              </ul>
            </div>
            <div class="promo-controls">
              <label>Khuyến mãi (chỉ áp dụng khi đã chọn khách)</label>
              <div class="promo-inputs">
                <input type="number" min="0" max="100" [(ngModel)]="promoPercent" [disabled]="!selectedCustomerId" placeholder="%">
                <input type="number" min="0" [(ngModel)]="promoFixed" [disabled]="!selectedCustomerId" placeholder="₫">
              </div>
              <div class="promo-note" *ngIf="!selectedCustomerId">
                <small>Chưa chọn khách - khuyến mãi sẽ không được áp dụng.</small>
              </div>
            </div>
            <div class="summary-row">
              <span>Tổng số lượng:</span>
              <strong>{{ getTotalItems() }} sản phẩm</strong>
            </div>
            <div class="summary-row">
              <span>Tổng tiền:</span>
              <strong>{{ getTotalAmount() | number:'1.0-0' }} đ</strong>
            </div>
            <div class="summary-row" *ngIf="getSelectedCustomer()">
              <span>Điểm hiện có:</span>
              <strong>{{ getPointsAvailable() }} điểm</strong>
            </div>
            <div class="summary-row" *ngIf="getPointsDiscountAmount() > 0">
              <span>Giảm điểm ({{ getPointsToUse() }} điểm × {{ pointsRate | number:'1.0-0' }} đ)</span>
              <strong class="discount-amount">-{{ getPointsDiscountAmount() | number:'1.0-0' }} đ</strong>
            </div>

            <div class="summary-row" *ngIf="(getTotalAmount() - getPointsDiscountAmount()) > 0">
              <span>Tổng sau trừ điểm (chưa trừ khuyến mãi):</span>
              <strong>{{ (getTotalAmount() - getPointsDiscountAmount()) | number:'1.0-0' }} đ</strong>
            </div>

            <div class="summary-row" *ngIf="selectedCustomerId && getPromoAmount(getTotalAmount() - getPointsDiscountAmount()) > 0">
              <span>Khuyến mãi</span>
              <strong class="discount-amount">-{{ getPromoAmount(getTotalAmount() - getPointsDiscountAmount()) | number:'1.0-0' }} đ</strong>
            </div>
            <div class="summary-row total">
              <span>Tổng cuối cùng:</span>
              <strong class="total-amount">{{ (getTotalAmount() - getPointsDiscountAmount() - getPromoAmount(getTotalAmount() - getPointsDiscountAmount())) | number:'1.0-0' }} đ</strong>
            </div>
          </div>
          <button class="btn-checkout" (click)="checkout()">
            <i class="fas fa-cash-register"></i>
            Thanh toán
          </button>
        </div>
      </div>
    </div>
  </main>
</div>